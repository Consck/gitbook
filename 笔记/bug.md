> 吃一堑长一智，每一次故障都是人生经验

# sentinel限流失败

时间：2020年6月

事件：数据总线使用限流，上线前测试完成，但对限流知识了解不够。服务上线后发现限流配置参数未起作用，使得服务在高峰期时无法承载。

原因：并未对规则参数做到了然于心。没有完全吃透sentinel限流。因此我决定认真搞一搞限流核心。

教训：遇到新的知识，一定要吃透!

# 线程池使用不当

时间：2020年11月

事件：代码开发完成后请求测试，仅验证功能没发现问题。服务上线三天后发生线程阻塞，导致CPU无法处理新的请求。

原因：线程不够，代码执行也比较耗时，CPU占用量大，没办法处理新的请求了。上线前没想到接口请求量比较大的问题，测试的时候也只验证了功能，没考虑到线程的问题。写完代码没有考虑到高峰期请求量过大的问题，上线前没有压测。在接口请求量比较大的时候没有考虑做一个代码开关，无法做到出现问题及时控制。并且线程池配置参数较小，不足以支撑高峰期请求量。

教训：上线前要考虑全面，包括功能和承受力！遇到不确定的情况时，做一个开关，能及时止损！

# 数据表主键ID超出字段类型

时间：2021年8月2日

事件：APP和音箱绑定时接口返回成功，但实际数据库写入失败。导致新绑定的设备没有收到推送。

原因：接口采用jdbc数据库操作方式，```jdbcTemplate.batchUpdate()```在数据插入出错时不会抛出异常，用Exception异常无法捕获，不易排查故障。主键ID创建数据表时字段为int(11)，临时解决方案改为bigint(11)。当数据表中已有数据做更新动作时，会删掉已有记录，并更新最大ID那条数据库记录。所有更新记录的动作都在操作最大ID对应的数据表记录，但是insert记录就会报错```Execute: Duplicate entry '4294967295' for key 'PRIMARY'```。
```SQL
"insert into push_target () values(?,?,?,?,?) on duplicate key update id=?"
```

教训：出现问题时要冷静，理清楚思路。自己尝试复现问题，问题影响范围较大时考虑共性原因。
                    
# 接口服务请求超时

时间：2021年9月18日

事件：音箱存在漏播现象，并拿到漏播订单号

原因：请求经过ingress，ingress可以理解为代理，但其中有一个ingress节点出了问题，异致经过这台节点的请求不能转发到下游服务。ingress本身没有问题，但这台机器依赖的K8S的网络插件出问题了，所以不会自动退出。ingress是一个节点池，里面有8台，通过负载均衡的方法分发请求，只有经过这台有问题的节点的请求不能往下转发，下掉有问题的节点，请求就到另外7台上面了